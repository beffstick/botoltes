<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RBC (Robot Botol Cuan)</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Pustaka HTML5-QRCode Dihapus -->
    <style>
        /* CSS untuk mengatur tampilan cetak */
        @media print {
            /* Sembunyikan semuanya dulu */
            body * { visibility: hidden; }

            /* ATURAN CETAK STRUK (default, jika body TIDAK punya class .printing-recap) */
            body:not(.printing-recap) #voucher-container,
            body:not(.printing-recap) #voucher-container * { visibility: visible; }
            
            body:not(.printing-recap) #voucher-container {
                position: absolute;
                left: 0;
                top: 0;
                margin: 0; /* Hapus margin untuk print struk */
                padding: 5px; /* Kurangi padding */
                width: 300px; /* Lebar struk thermal standar */
                border: none;
                box-shadow: none;
                background-color: white;
                color: black;
                font-family: 'Courier New', Courier, monospace;
            }
            body:not(.printing-recap) #voucher-container h3, 
            body:not(.printing-recap) #voucher-container p, 
            body:not(.printing-recap) #voucher-container span, 
            body:not(.printing-recap) #voucher-container div {
                color: black;
                font-size: 12px; /* Ukuran font struk */
            }
            body:not(.printing-recap) #voucher-container h3 {
                font-size: 14px;
                font-weight: bold;
                text-align: center;
                text-transform: uppercase;
            }
            body:not(.printing-recap) #voucher-container #modal-buttons-print {
                display: none; /* Sembunyikan tombol saat mencetak */
            }
            body:not(.printing-recap) #voucher-items-list div {
                display: flex;
                justify-content: space-between;
            }
            body:not(.printing-recap) #voucher-total {
                border-top: 1px dashed #000;
                padding-top: 5px;
                margin-top: 5px;
                font-weight: bold;
                display: flex;
                justify-content: space-between;
            }

            /* ATURAN CETAK REKAP F4 (BARU, jika body PUNYA class .printing-recap) */
            
            body.printing-recap #recap-print-area,
            body.printing-recap #recap-print-area * {
                visibility: visible;
            }
            body.printing-recap #recap-print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                color: black;
                font-family: Arial, sans-serif;
                background-color: white;
            }
            body.printing-recap #recap-print-area h2 {
                font-size: 16pt;
                font-weight: bold;
                text-align: center;
                margin-bottom: 20px;
            }
            body.printing-recap #recap-print-area h3 {
                font-size: 12pt;
                margin-bottom: 10px;
            }
            body.printing-recap #recap-print-area table {
                width: 100%;
                border-collapse: collapse;
                font-size: 10pt;
            }
            body.printing-recap #recap-print-area th,
            body.printing-recap #recap-print-area td {
                border: 1px solid #000;
                padding: 8px;
                text-align: left;
            }
            body.printing-recap #recap-print-area th {
                background-color: #f2f2f2;
            }
            body.printing-recap #recap-print-area .totals {
                margin-top: 20px;
                font-size: 12pt;
                font-weight: bold;
            }
            body.printing-recap #recap-print-area .totals p {
                margin: 5px 0;
            }

        }
        
        /* Mencegah scroll saat modal terbuka */
        .modal-open { overflow: hidden; }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex items-center justify-center p-4">

    <!-- Kontainer Utama -->
    <div class="bg-white shadow-2xl rounded-lg overflow-hidden w-full max-w-md sm:max-w-xl">
        <!-- Bagian Pemindai Kamera Dihapus -->

        <!-- Bagian Informasi -->
        <div class="p-6 text-center">
            <!-- Tambahan Logo -->
            <div class="flex justify-center items-center space-x-6 mb-4">
                <img src="logosekolah.png" alt="Logo Sekolah" class="h-16 w-auto" onerror="this.src='https://placehold.co/64x64/eee/aaa?text=Logo+Sekolah&font=sans'">
                <img src="logoadiwiyata.png" alt="Logo Adiwiyata" class="h-16 w-auto" onerror="this.src='https://placehold.co/64x64/eee/aaa?text=Logo+Adiwiyata&font=sans'">
            </div>
            <h1 class="text-2xl font-bold text-gray-800 mb-2">RBC (Robot Botol Cuan)</h1>
            <p id="status-text" class="text-gray-500 mb-4">Ayo kasih makan robotnya pakai botol.</p>
            
            <!-- Input Pindai Baru -->
            <div class="my-6">
                <label for="scan-input" class="sr-only">Input Barcode</label>
                <input 
                    type="text" 
                    id="scan-input" 
                    placeholder="Klik di sini & pindai dengan scanner..." 
                    autofocus
                    class="w-full p-4 border-2 border-blue-300 rounded-lg text-lg text-center shadow-inner"
                >
            </div>

            <div class="my-6">
                <span class="text-lg text-gray-600">Jumlah Botol</span>
                <div id="counter" class="text-6xl font-extrabold text-blue-600">
                    0 / 5
                </div>
            </div>
        </div>
    </div>

    <!-- MODIFIKASI: Grup Tombol Floating -->
    <div class="fixed bottom-6 right-6 z-20 flex flex-col space-y-3">
        <!-- Tombol Buka Database Botol -->
        <button id="show-db-button" class="bg-green-600 hover:bg-green-700 text-white rounded-full p-4 shadow-lg" title="Buka Database Botol">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4m0 0v10" />
            </svg>
        </button>
        
        <!-- Tombol Buka Rekap -->
        <button id="show-recap-button" class="bg-purple-600 hover:bg-purple-700 text-white rounded-full p-4 shadow-lg" title="Buka Rekap Harian">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M17 5V3a2 2 0 00-2-2H9a2 2 0 00-2 2v2" />
            </svg>
        </button>
    </div>


    <!-- ============================== -->
    <!-- ==== MODAL STRUK PENUKARAN ==== -->
    <!-- ============================== -->
    <div id="popup-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div id="voucher-container" class="bg-white rounded-lg shadow-xl p-8 max-w-lg w-full">
            <!-- ... Konten modal struk (tidak berubah) ... -->
            <!-- Tambahan Logo Struk -->
            <div class="flex justify-center items-center space-x-4 mb-4">
                <img src="logosekolah.png" alt="Logo Sekolah" class="h-12 w-auto" onerror="this.src='https://placehold.co/48x48/eee/aaa?text=Logo+Sekolah&font=sans'">
                <img src="logoadiwiyata.png" alt="Logo Adiwiyata" class="h-12 w-auto" onerror="this.src='https://placehold.co/48x48/eee/aaa?text=Logo+Adiwiyata&font=sans'">
            </div>
            <h3 class="text-xl font-bold uppercase text-gray-800 mb-4 text-center">Struk Penukaran Botol</h3>
            
            <!-- Info Transaksi -->
            <div class="text-sm text-gray-600 mb-4 space-y-1">
                <p><strong>Tanggal:</strong> <span id="voucher-date"></span></p>
                <p><strong>ID Transaksi:</strong> <span id="voucher-id"></span></p>
            </div>

            <!-- Rincian Item Struk -->
            <div id="voucher-items-list" class="mb-4 space-y-2">
                <!-- Item akan dimasukkan oleh JS di sini -->
            </div>
            
            <!-- Total Struk -->
            <div id="voucher-total" class="text-lg font-bold pt-2 border-t border-dashed border-gray-400">
                <span>TOTAL</span>
                <span id="voucher-total-price">Rp0</span>
            </div>

            <p class="text-center text-sm text-gray-700 mt-6">Struk ini bisa ditukarkan menjadi uang</p>

            <!-- Tombol Aksi (Hanya untuk layar, hilang saat print) -->
            <div id="modal-buttons-print" class="mt-8 space-y-3">
                <button id="print-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-300">
                    Cetak Struk
                </button>
                <button id="close-button" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-4 rounded-lg text-lg transition duration-300">
                    Tutup & Pindai Lagi
                </button>
            </div>
        </div>
    </div>

    <!-- ============================== -->
    <!-- ==== MODAL DATABASE BOTOL (BARU) ==== -->
    <!-- ============================== -->
    <div id="db-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-40 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-xl w-full max-h-[90vh] flex flex-col">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Database Botol</h2>
            
            <!-- Form Tambah/Edit Master Data -->
            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                <h3 class="text-lg font-semibold mb-3">Tambah Data Botol Baru</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                    <input id="barcode-input" type="text" placeholder="Nomor Barcode" class="md:col-span-2 p-2 border rounded">
                    <input id="name-input" type="text" placeholder="Nama Botol" class="p-2 border rounded">
                    <input id="price-input" type="number" placeholder="Harga" class="p-2 border rounded">
                </div>
                <button id="add-bottle-button" class="mt-3 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                    Simpan ke Database
                </button>
            </div>

            <!-- Daftar Botol (Master Data) -->
            <div class="flex-1 overflow-y-auto mb-6">
                <h3 class="text-lg font-semibold mb-3">Isi Database Botol (Disimpan di HP Anda)</h3>
                <div id="master-data-list" class="space-y-2 max-h-60 overflow-y-auto border p-3 rounded">
                    <!-- Master data list populated by JS -->
                    <p class="text-gray-500">Database kosong. Silakan tambahkan data.</p>
                </div>
            </div>

            <button id="close-db-button" class="mt-6 w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-4 rounded-lg text-lg transition duration-300">
                Tutup
            </button>
        </div>
    </div>

    <!-- ============================== -->
    <!-- ==== MODAL REKAP HARIAN (BARU) ==== -->
    <!-- ============================== -->
    <div id="recap-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-40 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-xl w-full max-h-[90vh] flex flex-col">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Rekap Harian</h2>

            <!-- Rekap Harian (Menggantikan Rekap Sesi Ini) -->
            <div class="flex-1 overflow-y-auto">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-semibold">Rekap Harian</h3>
                    <!-- Grup Tombol & Tanggal -->
                    <div class="flex items-center space-x-2">
                        <input type="date" id="recap-date-picker" class="p-2 border rounded text-sm">
                        <!-- Tombol Cetak Rekap BARU -->
                        <button id="print-recap-button" class="p-2 bg-blue-600 hover:bg-blue-700 text-white rounded" title="Cetak Rekap Harian">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H7a2 2 0 00-2 2v4a2 2 0 002 2h2m8-6a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2h6a2 2 0 002-2v-4zM7 17V5a2 2 0 012-2h6a2 2 0 012 2v12" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="mb-2 text-sm font-medium text-gray-700">
                    Total Botol: <span id="recap-count" class="font-bold text-blue-600">0</span> | 
                    Total Pemasukan: <span id="recap-total-price" class="font-bold text-green-600">Rp0</span>
                </div>

                <div id="recap-list" class="space-y-2 max-h-60 overflow-y-auto border p-3 rounded">
                    <!-- Scanned items list populated by JS -->
                    <p class="text-gray-500">Pilih tanggal untuk melihat rekap.</p>
                </div>
            </div>

            <button id="close-recap-button" class="mt-6 w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-4 rounded-lg text-lg transition duration-300">
                Tutup
            </button>
        </div>
    </div>

    <!-- Area Cetak Rekap Harian (Tersembunyi) BARU -->
    <div id="recap-print-area"></div>


    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            // ===================================
            // === VARIABEL GLOBAL & STATE APLIKASI
            // ===================================
            let scannedCount = 0;
            const targetCount = 5;
            let isScanning = false; // <-- BARU: Tambahkan flag delay
            
            // State baru untuk database dan rekap
            let bottleMasterData = new Map(); // Map(barcode, {name, price})
            let scannedBottles = []; // Array dari {barcode, name, price} (HANYA SESI INI)
            let dailyRecapData = []; // Array dari semua transaksi (PERMANEN)

            // Fungsi format Rupiah
            const formatter = new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            });

            // ===================================
            // === REFERENSI ELEMEN DOM
            // ===================================
            const counterElement = document.getElementById('counter');
            const statusTextElement = document.getElementById('status-text');
            const scanInputElement = document.getElementById('scan-input'); // Input baru

            // DOM Modal Struk
            const modalElement = document.getElementById('popup-modal');
            const printButton = document.getElementById('print-button');
            const closeButton = document.getElementById('close-button');
            const voucherDateElement = document.getElementById('voucher-date');
            const voucherIdElement = document.getElementById('voucher-id');
            const voucherItemsListElement = document.getElementById('voucher-items-list');
            const voucherTotalPriceElement = document.getElementById('voucher-total-price');

            // --- MODIFIKASI: DOM Modal Rekap & DB ---
            // Tombol Floating Baru
            const showRecapButton = document.getElementById('show-recap-button');
            const showDbButton = document.getElementById('show-db-button');

            // Modal Rekap Harian
            const recapModalElement = document.getElementById('recap-modal');
            const closeRecapButton = document.getElementById('close-recap-button');
            const recapListElement = document.getElementById('recap-list');
            const recapCountElement = document.getElementById('recap-count');
            const recapDatePicker = document.getElementById('recap-date-picker');
            const recapTotalPriceElement = document.getElementById('recap-total-price');
            const printRecapButton = document.getElementById('print-recap-button');
            const recapPrintArea = document.getElementById('recap-print-area');
            
            // Modal Database Botol
            const dbModalElement = document.getElementById('db-modal');
            const closeDbButton = document.getElementById('close-db-button');
            const addBottleButton = document.getElementById('add-bottle-button');
            const barcodeInputElement = document.getElementById('barcode-input');
            const nameInputElement = document.getElementById('name-input');
            const priceInputElement = document.getElementById('price-input');
            const masterDataListElement = document.getElementById('master-data-list');
            // --- AKHIR MODIFIKASI ---


            // ===================================
            // === FUNGSI DATABASE (LOCALSTORAGE)
            // ===================================
            function saveMasterData() {
                // Convert Map ke Array untuk JSON.stringify
                const dataArray = Array.from(bottleMasterData.entries());
                localStorage.setItem('bottleMasterData', JSON.stringify(dataArray));
                console.log('Database disimpan:', dataArray);
                updateMasterDataListUI();
            }

            function loadPersistentData() {
                // Load Master Data
                const masterDataString = localStorage.getItem('bottleMasterData');
                if (masterDataString) {
                    try {
                        const dataArray = JSON.parse(masterDataString);
                        bottleMasterData = new Map(dataArray);
                        console.log('Database dimuat:', bottleMasterData);
                    } catch (e) {
                        console.error('Gagal memuat database:', e);
                        bottleMasterData = new Map();
                    }
                }
                updateMasterDataListUI();

                // Load Recap Data
                const recapDataString = localStorage.getItem('dailyRecapData');
                if (recapDataString) {
                    try {
                        dailyRecapData = JSON.parse(recapDataString);
                        console.log('Data rekap dimuat:', dailyRecapData);
                    } catch (e) {
                        console.error('Gagal memuat rekap:', e);
                        dailyRecapData = [];
                    }
                }
            }

            // Fungsi baru untuk menyimpan rekap
            function saveDailyRecap(transaction) {
                dailyRecapData.push(transaction);
                localStorage.setItem('dailyRecapData', JSON.stringify(dailyRecapData));
                console.log('Rekap harian disimpan:', transaction);
            }
            
            function handleAddMasterData() {
                const barcode = barcodeInputElement.value.trim();
                const name = nameInputElement.value.trim();
                const price = parseInt(priceInputElement.value) || 0;

                if (!barcode || !name) {
                    // Menggunakan notifikasi kustom, bukan alert()
                    statusTextElement.textContent = 'Nomor Barcode dan Nama Botol tidak boleh kosong!';
                    statusTextElement.classList.add('text-red-500');
                    setTimeout(() => {
                         statusTextElement.textContent = 'Letakkan kursor di input di bawah dan mulai pindai.';
                         statusTextElement.classList.remove('text-red-500');
                    }, 3000);
                    return;
                }

                bottleMasterData.set(barcode, { name, price });
                saveMasterData();

                // Kosongkan form
                barcodeInputElement.value = '';
                nameInputElement.value = '';
                priceInputElement.value = '';
            }

            // ===================================
            // === FUNGSI UPDATE UI (NON-SCANNER)
            // ===================================
            
            function updateMasterDataListUI() {
                masterDataListElement.innerHTML = ''; // Kosongkan
                if (bottleMasterData.size === 0) {
                    masterDataListElement.innerHTML = '<p class="text-gray-500">Database kosong. Silakan tambahkan data.</p>';
                    return;
                }
                
                bottleMasterData.forEach((data, barcode) => {
                    const item = document.createElement('div');
                    item.className = 'p-2 bg-white border rounded text-sm flex justify-between';
                    item.innerHTML = `
                        <span>
                            <strong class="text-purple-700">${data.name}</strong> (${barcode})
                        </span>
                        <span class="font-semibold">${formatter.format(data.price)}</span>
                    `;
                    masterDataListElement.appendChild(item);
                });
            }

            function updateDailyRecapUI(selectedDate) {
                recapListElement.innerHTML = ''; // Kosongkan
                
                // Filter transaksi untuk tanggal yang dipilih
                const dailyTransactions = dailyRecapData.filter(tx => 
                    tx.date.startsWith(selectedDate)
                );

                if (dailyTransactions.length === 0) {
                    recapListElement.innerHTML = '<p class="text-gray-500">Tidak ada data untuk tanggal ini.</p>';
                    recapCountElement.textContent = '0';
                    recapTotalPriceElement.textContent = formatter.format(0);
                    return;
                }

                let allBottles = [];
                let totalDailyPrice = 0;

                // Gabungkan semua botol dari semua transaksi di hari itu
                dailyTransactions.forEach(tx => {
                    allBottles = allBottles.concat(tx.items);
                    totalDailyPrice += tx.total;
                });

                recapCountElement.textContent = allBottles.length;
                recapTotalPriceElement.textContent = formatter.format(totalDailyPrice);

                allBottles.forEach((botol, index) => {
                    const item = document.createElement('div');
                    item.className = 'p-2 bg-white border rounded text-sm flex justify-between';
                    item.innerHTML = `
                        <span>
                            <strong>${botol.name}</strong>
                            ${botol.price > 0 ? '' : `(${botol.barcode})`}
                        </span>
                        <span class="font-semibold">${formatter.format(botol.price)}</span>
                    `;
                    recapListElement.appendChild(item);
                });
            }

            // --- MODIFIKASI: Fungsi Modal Dipisah ---
            function showRecapModal() {
                // Atur pemilih tanggal ke hari ini & panggil rekap
                const today = getTodayDateString();
                recapDatePicker.value = today;
                updateDailyRecapUI(today);
                
                recapModalElement.classList.remove('hidden');
                document.body.classList.add('modal-open');
            }

            function hideRecapModal() {
                recapModalElement.classList.add('hidden');
                document.body.classList.remove('modal-open');
                scanInputElement.focus(); // Fokus kembali ke input scan
            }

            function showDbModal() {
                updateMasterDataListUI(); // Hanya update list master data
                dbModalElement.classList.remove('hidden');
                document.body.classList.add('modal-open');
            }

            function hideDbModal() {
                dbModalElement.classList.add('hidden');
                document.body.classList.remove('modal-open');
                scanInputElement.focus(); // Fokus kembali ke input scan
            }
            // --- AKHIR MODIFIKASI ---


            /* =================================== */
            // === FUNGSI CETAK REKAP
            /* =================================== */
            function handlePrintRecap() {
                const selectedDate = recapDatePicker.value;
                if (!selectedDate) {
                    // Tampilkan notifikasi, jangan alert
                    statusTextElement.textContent = 'Pilih tanggal terlebih dahulu!';
                    statusTextElement.classList.add('text-red-500');
                    setTimeout(() => {
                         statusTextElement.textContent = 'Letakkan kursor di input di bawah dan mulai pindai.';
                         statusTextElement.classList.remove('text-red-500');
                    }, 3000);
                    return;
                }

                // 1. Filter data (sama seperti di updateDailyRecapUI)
                const dailyTransactions = dailyRecapData.filter(tx => 
                    tx.date.startsWith(selectedDate)
                );

                if (dailyTransactions.length === 0) {
                     statusTextElement.textContent = 'Tidak ada data untuk dicetak pada tanggal ini.';
                    statusTextElement.classList.add('text-red-500');
                    setTimeout(() => {
                         statusTextElement.textContent = 'Letakkan kursor di input di bawah dan mulai pindai.';
                         statusTextElement.classList.remove('text-red-500');
                    }, 3000);
                    return;
                }

                let allBottles = [];
                let totalDailyPrice = 0;
                dailyTransactions.forEach(tx => {
                    allBottles = allBottles.concat(tx.items);
                    totalDailyPrice += tx.total;
                });

                // 2. Build HTML String untuk area cetak
                let html = `
                    <h2>Rekap Harian Penukaran Botol</h2>
                    <h3>Tanggal: ${new Date(selectedDate).toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</h3>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>Nama Botol</th>
                                <th>Barcode</th>
                                <th>Harga</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                allBottles.forEach((botol, index) => {
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${botol.name}</td>
                            <td>${botol.barcode}</td>
                            <td>${formatter.format(botol.price)}</td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                    
                    <div class="totals">
                        <p>Total Botol: ${allBottles.length}</p>
                        <p>Total Pemasukan: ${formatter.format(totalDailyPrice)}</p>
                    </div>
                `;

                // 3. Inject F4 page style (BARU)
                const f4Style = document.createElement('style');
                f4Style.id = 'f4-print-style'; // Beri ID agar bisa dihapus nanti
                f4Style.innerHTML = `
                    @media print {
                        @page {
                            size: 215mm 330mm; /* Ukuran kertas F4 */
                            margin: 20mm; /* Margin 2cm */
                        }
                    }
                `;
                document.head.appendChild(f4Style);

                // 4. Inject HTML, tambahkan kelas, dan panggil print
                recapPrintArea.innerHTML = html;
                document.body.classList.add('printing-recap');
                window.print();
            }

            // ===================================
            // === FUNGSI LOGIKA SCANNER
            // ===================================

            function processScan(decodedText) {
                // MODIFIKASI: Cek flag delay
                if (isScanning) {
                    return; // Keluar jika sedang dalam masa tunggu
                }

                // MODIFIKASI: Cek kedua modal
                if (!modalElement.classList.contains('hidden') || !recapModalElement.classList.contains('hidden') || !dbModalElement.classList.contains('hidden')) {
                    return; // Jangan proses jika modal terbuka
                }

                // MODIFIKASI: Atur flag delay
                isScanning = true;

                console.log(`Scan diproses: ${decodedText}`);
                
                // 1. Cari info botol di database
                const bottleInfo = bottleMasterData.get(decodedText) || { name: 'Botol Tidak Dikenal', price: 0 };
                
                // 2. Tambahkan ke daftar pindaian sesi ini
                const scannedBottle = {
                    barcode: decodedText,
                    name: bottleInfo.name,
                    price: bottleInfo.price
                };
                scannedBottles.push(scannedBottle);
                
                // 3. Tambah hitungan
                scannedCount++;
                
                // 4. Perbarui UI
                counterElement.textContent = `${scannedCount} / ${targetCount}`;
                statusTextElement.textContent = `Botol: ${scannedBottle.name} (${formatter.format(scannedBottle.price)})`;

                if (window.navigator.vibrate) window.navigator.vibrate(100);

                // 5. Cek jika sudah mencapai target
                if (scannedCount >= targetCount) {
                    showVoucherPopup();
                }

                // MODIFIKASI: Tambahkan delay 1 detik sebelum scan berikutnya
                setTimeout(() => {
                    isScanning = false; // Buka kunci flag
                    scanInputElement.value = ''; // Kosongkan input
                    
                    // Fokus kembali ke input HANYA jika tidak ada modal yang terbuka
                    if (modalElement.classList.contains('hidden') && 
                        recapModalElement.classList.contains('hidden') && 
                        dbModalElement.classList.contains('hidden')) 
                    {
                        scanInputElement.focus();
                    }
                }, 1000); // 1000 ms = 1 detik delay
            }


            function showVoucherPopup() {
                // ... (Fungsi ini tidak berubah) ...
                const now = new Date();
                const txId = `TX-${Date.now()}`;
                voucherDateElement.textContent = now.toLocaleString('id-ID', { dateStyle: 'long', timeStyle: 'short' });
                voucherIdElement.textContent = txId;
                voucherItemsListElement.innerHTML = '';
                let totalPrice = 0;
                scannedBottles.forEach(botol => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between text-sm';
                    item.innerHTML = `
                        <span>${botol.name}</span>
                        <span>${formatter.format(botol.price)}</span>
                    `;
                    voucherItemsListElement.appendChild(item);
                    totalPrice += botol.price;
                });
                voucherTotalPriceElement.textContent = formatter.format(totalPrice);
                const transaction = {
                    id: txId,
                    date: now.toISOString(),
                    items: [...scannedBottles],
                    total: totalPrice
                };
                saveDailyRecap(transaction);
                modalElement.classList.remove('hidden');
                document.body.classList.add('modal-open');
            }
            
            function resetSession() {
                // ... (Fungsi ini tidak berubah) ...
                modalElement.classList.add('hidden');
                document.body.classList.remove('modal-open');
                scannedCount = 0;
                scannedBottles = [];
                counterElement.textContent = `${scannedCount} / ${targetCount}`;
                statusTextElement.textContent = "Siap untuk memindai...";
                scanInputElement.value = '';
                scanInputElement.focus();
            }

            // ===================================
            // === EVENT LISTENERS
            // ===================================

            scanInputElement.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.keyCode === 13) {
                    e.preventDefault();
                    const barcode = scanInputElement.value.trim();
                    if (barcode) {
                        processScan(barcode);
                    }
                    // Dihapus: Pembersihan input dipindah ke processScan
                }
            });

            // Tombol Cetak Struk
            printButton.addEventListener('click', () => {
                window.print();
            });

            // Tombol Tutup Struk & Pindai Lagi
            closeButton.addEventListener('click', resetSession);

            // Listener baru untuk pemilih tanggal rekap
            recapDatePicker.addEventListener('change', (e) => {
                updateDailyRecapUI(e.target.value);
            });

            // Listener baru untuk tombol cetak rekap
            printRecapButton.addEventListener('click', handlePrintRecap);

            // Tombol Simpan Data Botol
            addBottleButton.addEventListener('click', handleAddMasterData);
            
            // --- MODIFIKASI: Event Listener Modal Dipisah ---
            // Tombol Buka Rekap
            showRecapButton.addEventListener('click', showRecapModal);
            // Tombol Tutup Rekap
            closeRecapButton.addEventListener('click', hideRecapModal);

            // Tombol Buka Database
            showDbButton.addEventListener('click', showDbModal);
            // Tombol Tutup Database
            closeDbButton.addEventListener('click', hideDbModal);
            // --- AKHIR MODIFIKASI ---


            // Listener baru untuk membersihkan setelah cetak
            window.addEventListener('afterprint', () => {
                document.body.classList.remove('printing-recap');
                recapPrintArea.innerHTML = ''; // Kosongkan area cetak
                const f4Style = document.getElementById('f4-print-style');
                if (f4Style) {
                    f4Style.remove();
                }
            });

            // ===================================
            // === INISIALISASI APLIKASI
            // ===================================
            function getTodayDateString() {
                const today = new Date();
                const year = today.getFullYear();
                const month = (today.getMonth() + 1).toString().padStart(2, '0');
                const day = today.getDate().toString().padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            loadPersistentData();
            scanInputElement.focus();
        });
    </script>
</body>
</html>



