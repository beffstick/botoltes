<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan Barcode Botol</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Pustaka HTML5-QRCode Dihapus -->
    <style>
        /* CSS untuk mengatur tampilan cetak */
        @media print {
            body * { visibility: hidden; }
            #voucher-container, #voucher-container * { visibility: visible; }
            #voucher-container {
                position: absolute;
                left: 0;
                top: 0;
                margin: 20px;
                padding: 20px;
                width: 300px; /* Lebar struk thermal standar */
                border: none;
                box-shadow: none;
                background-color: white;
                color: black;
                font-family: 'Courier New', Courier, monospace;
            }
            #voucher-container h3, #voucher-container p, #voucher-container span, #voucher-container div {
                color: black;
                font-size: 12px; /* Ukuran font struk */
            }
            #voucher-container h3 {
                font-size: 14px;
                font-weight: bold;
                text-align: center;
                text-transform: uppercase;
            }
            #voucher-container #modal-buttons-print {
                display: none; /* Sembunyikan tombol saat mencetak */
            }
            #voucher-items-list div {
                display: flex;
                justify-content: space-between;
            }
            #voucher-total {
                border-top: 1px dashed #000;
                padding-top: 5px;
                margin-top: 5px;
                font-weight: bold;
                display: flex;
                justify-content: space-between;
            }
        }

        /* CSS untuk reader kamera dihapus */
        
        /* Mencegah scroll saat modal terbuka */
        .modal-open { overflow: hidden; }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex items-center justify-center p-4">

    <!-- Kontainer Utama -->
    <div class="bg-white shadow-2xl rounded-lg overflow-hidden w-full max-w-md sm:max-w-xl">
        <!-- Bagian Pemindai Kamera Dihapus -->

        <!-- Bagian Informasi -->
        <div class="p-6 text-center">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">Scan Barcode Botol</h1>
            <p id="status-text" class="text-gray-500 mb-4">Letakkan kursor di input di bawah dan mulai pindai.</p>
            
            <!-- Input Pindai Baru -->
            <div class="my-6">
                <label for="scan-input" class="sr-only">Input Barcode</label>
                <input 
                    type="text" 
                    id="scan-input" 
                    placeholder="Klik di sini & pindai dengan scanner..." 
                    autofocus
                    class="w-full p-4 border-2 border-blue-300 rounded-lg text-lg text-center shadow-inner"
                >
            </div>

            <div class="my-6">
                <span class="text-lg text-gray-600">Jumlah Botol</span>
                <div id="counter" class="text-6xl font-extrabold text-blue-600">
                    0 / 5
                </div>
            </div>
        </div>
    </div>

    <!-- Tombol Buka Rekap (Floating Action Button) -->
    <button id="recap-button" class="fixed bottom-6 right-6 bg-purple-600 hover:bg-purple-700 text-white rounded-full p-4 shadow-lg z-20" title="Buka Rekap & Database Botol">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M17 5V3a2 2 0 00-2-2H9a2 2 0 00-2 2v2" />
        </svg>
    </button>

    <!-- ============================== -->
    <!-- ==== MODAL STRUK PENUKARAN ==== -->
    <!-- ============================== -->
    <div id="popup-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div id="voucher-container" class="bg-white rounded-lg shadow-xl p-8 max-w-lg w-full">
            <h3 class="text-xl font-bold uppercase text-gray-800 mb-4 text-center">Struk Penukaran Botol</h3>
            
            <!-- Info Transaksi -->
            <div class="text-sm text-gray-600 mb-4 space-y-1">
                <p><strong>Tanggal:</strong> <span id="voucher-date"></span></p>
                <p><strong>ID Transaksi:</strong> <span id="voucher-id"></span></p>
            </div>

            <!-- Rincian Item Struk -->
            <div id="voucher-items-list" class="mb-4 space-y-2">
                <!-- Item akan dimasukkan oleh JS di sini -->
            </div>
            
            <!-- Total Struk -->
            <div id="voucher-total" class="text-lg font-bold pt-2 border-t border-dashed border-gray-400">
                <span>TOTAL</span>
                <span id="voucher-total-price">Rp0</span>
            </div>

            <p class="text-center text-sm text-gray-700 mt-6">Struk ini bisa ditukarkan menjadi uang</p>

            <!-- Tombol Aksi (Hanya untuk layar, hilang saat print) -->
            <div id="modal-buttons-print" class="mt-8 space-y-3">
                <button id="print-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-300">
                    Cetak Struk
                </button>
                <button id="close-button" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-4 rounded-lg text-lg transition duration-300">
                    Tutup & Pindai Lagi
                </button>
            </div>
        </div>
    </div>

    <!-- ============================== -->
    <!-- ==== MODAL REKAP & DATABASE ==== -->
    <!-- ============================== -->
    <div id="recap-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-40 hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-xl w-full max-h-[90vh] flex flex-col">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Database Botol & Rekap Sesi</h2>
            
            <!-- Form Tambah/Edit Master Data -->
            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                <h3 class="text-lg font-semibold mb-3">Tambah Data Botol Baru</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                    <input id="barcode-input" type="text" placeholder="Nomor Barcode" class="md:col-span-2 p-2 border rounded">
                    <input id="name-input" type="text" placeholder="Nama Botol" class="p-2 border rounded">
                    <input id="price-input" type="number" placeholder="Harga" class="p-2 border rounded">
                </div>
                <button id="add-bottle-button" class="mt-3 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                    Simpan ke Database
                </button>
            </div>

            <!-- Daftar Botol (Master Data) -->
            <div class="flex-1 overflow-y-auto mb-6">
                <h3 class="text-lg font-semibold mb-3">Isi Database Botol (Disimpan di HP Anda)</h3>
                <div id="master-data-list" class="space-y-2 max-h-40 overflow-y-auto border p-3 rounded">
                    <!-- Master data list populated by JS -->
                    <p class="text-gray-500">Database kosong. Silakan tambahkan data.</p>
                </div>
            </div>

            <!-- Rekap Sesi Ini -->
            <div class="flex-1 overflow-y-auto">
                <h3 class="text-lg font-semibold mb-3">Rekap Sesi Ini (Total: <span id="recap-count">0</span>)</h3>
                <div id="recap-list" class="space-y-2 max-h-40 overflow-y-auto border p-3 rounded">
                    <!-- Scanned items list populated by JS -->
                    <p class="text-gray-500">Belum ada botol yang dipindai.</p>
                </div>
            </div>

            <button id="close-recap-button" class="mt-6 w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-4 rounded-lg text-lg transition duration-300">
                Tutup
            </button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            // ===================================
            // === VARIABEL GLOBAL & STATE APLIKASI
            // ===================================
            let scannedCount = 0;
            const targetCount = 5;
            // Variabel html5QrcodeScanner dihapus
            
            // State baru untuk database dan rekap
            let bottleMasterData = new Map(); // Map(barcode, {name, price})
            let scannedBottles = []; // Array dari {barcode, name, price}

            // Fungsi format Rupiah
            const formatter = new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            });

            // ===================================
            // === REFERENSI ELEMEN DOM
            // ===================================
            const counterElement = document.getElementById('counter');
            const statusTextElement = document.getElementById('status-text');
            const scanInputElement = document.getElementById('scan-input'); // Input baru

            // DOM Modal Struk
            const modalElement = document.getElementById('popup-modal');
            const printButton = document.getElementById('print-button');
            const closeButton = document.getElementById('close-button');
            const voucherDateElement = document.getElementById('voucher-date');
            const voucherIdElement = document.getElementById('voucher-id');
            const voucherItemsListElement = document.getElementById('voucher-items-list');
            const voucherTotalPriceElement = document.getElementById('voucher-total-price');

            // DOM Modal Rekap
            const recapButton = document.getElementById('recap-button');
            const recapModalElement = document.getElementById('recap-modal');
            const closeRecapButton = document.getElementById('close-recap-button');
            const addBottleButton = document.getElementById('add-bottle-button');
            const barcodeInputElement = document.getElementById('barcode-input');
            const nameInputElement = document.getElementById('name-input');
            const priceInputElement = document.getElementById('price-input');
            const masterDataListElement = document.getElementById('master-data-list');
            const recapListElement = document.getElementById('recap-list');
            const recapCountElement = document.getElementById('recap-count');

            // ===================================
            // === FUNGSI DATABASE (LOCALSTORAGE)
            // ===================================
            function saveMasterData() {
                // Convert Map ke Array untuk JSON.stringify
                const dataArray = Array.from(bottleMasterData.entries());
                localStorage.setItem('bottleMasterData', JSON.stringify(dataArray));
                console.log('Database disimpan:', dataArray);
                updateMasterDataListUI();
            }

            function loadMasterData() {
                const dataString = localStorage.getItem('bottleMasterData');
                if (dataString) {
                    try {
                        const dataArray = JSON.parse(dataString);
                        bottleMasterData = new Map(dataArray);
                        console.log('Database dimuat:', bottleMasterData);
                    } catch (e) {
                        console.error('Gagal memuat database:', e);
                        bottleMasterData = new Map();
                    }
                }
                updateMasterDataListUI();
            }
            
            function handleAddMasterData() {
                const barcode = barcodeInputElement.value.trim();
                const name = nameInputElement.value.trim();
                const price = parseInt(priceInputElement.value) || 0;

                if (!barcode || !name) {
                    // Menggunakan notifikasi kustom, bukan alert()
                    statusTextElement.textContent = 'Nomor Barcode dan Nama Botol tidak boleh kosong!';
                    statusTextElement.classList.add('text-red-500');
                    setTimeout(() => {
                         statusTextElement.textContent = 'Letakkan kursor di input di bawah dan mulai pindai.';
                         statusTextElement.classList.remove('text-red-500');
                    }, 3000);
                    return;
                }

                bottleMasterData.set(barcode, { name, price });
                saveMasterData();

                // Kosongkan form
                barcodeInputElement.value = '';
                nameInputElement.value = '';
                priceInputElement.value = '';
            }

            // ===================================
            // === FUNGSI UPDATE UI (NON-SCANNER)
            // ===================================
            
            function updateMasterDataListUI() {
                masterDataListElement.innerHTML = ''; // Kosongkan
                if (bottleMasterData.size === 0) {
                    masterDataListElement.innerHTML = '<p class="text-gray-500">Database kosong. Silakan tambahkan data.</p>';
                    return;
                }
                
                bottleMasterData.forEach((data, barcode) => {
                    const item = document.createElement('div');
                    item.className = 'p-2 bg-white border rounded text-sm flex justify-between';
                    item.innerHTML = `
                        <span>
                            <strong class="text-purple-700">${data.name}</strong> (${barcode})
                        </span>
                        <span class="font-semibold">${formatter.format(data.price)}</span>
                    `;
                    masterDataListElement.appendChild(item);
                });
            }

            function updateRecapListUI() {
                recapListElement.innerHTML = ''; // Kosongkan
                recapCountElement.textContent = scannedBottles.length;

                if (scannedBottles.length === 0) {
                    recapListElement.innerHTML = '<p class="text-gray-500">Belum ada botol yang dipindai.</p>';
                    return;
                }
                
                scannedBottles.forEach((botol, index) => {
                    const item = document.createElement('div');
                    item.className = 'p-2 bg-white border rounded text-sm flex justify-between';
                    item.innerHTML = `
                        <span>
                            <strong>${botol.name}</strong>
                            ${botol.price > 0 ? '' : `(${botol.barcode})`}
                        </span>
                        <span class="font-semibold">${formatter.format(botol.price)}</span>
                    `;
                    recapListElement.appendChild(item);
                });
            }

            function showRecapModal() {
                updateMasterDataListUI();
                updateRecapListUI();
                recapModalElement.classList.remove('hidden');
                document.body.classList.add('modal-open');
            }

            function hideRecapModal() {
                recapModalElement.classList.add('hidden');
                document.body.classList.remove('modal-open');
                scanInputElement.focus(); // Fokus kembali ke input scan
            }

            // ===================================
            // === FUNGSI LOGIKA SCANNER
            // ===================================

            // Mengganti onScanSuccess menjadi processScan
            function processScan(decodedText) {
                if (!modalElement.classList.contains('hidden') || !recapModalElement.classList.contains('hidden')) {
                    return; // Jangan proses jika modal terbuka
                }

                console.log(`Scan diproses: ${decodedText}`);
                
                // 1. Cari info botol di database
                const bottleInfo = bottleMasterData.get(decodedText) || { name: 'Botol Tidak Dikenal', price: 0 };
                
                // 2. Tambahkan ke daftar pindaian sesi ini
                const scannedBottle = {
                    barcode: decodedText,
                    name: bottleInfo.name,
                    price: bottleInfo.price
                };
                scannedBottles.push(scannedBottle);
                
                // 3. Tambah hitungan
                scannedCount++;
                
                // 4. Perbarui UI
                counterElement.textContent = `${scannedCount} / ${targetCount}`;
                statusTextElement.textContent = `Botol: ${scannedBottle.name} (${formatter.format(scannedBottle.price)})`;

                if (window.navigator.vibrate) window.navigator.vibrate(100);

                // 5. Cek jika sudah mencapai target
                if (scannedCount >= targetCount) {
                    // Tidak perlu stop scanner
                    showVoucherPopup();
                }
            }

            // Fungsi onScanError dan startScanner dihapus

            function showVoucherPopup() {
                // Isi data struk
                const now = new Date();
                voucherDateElement.textContent = now.toLocaleString('id-ID', { dateStyle: 'long', timeStyle: 'short' });
                voucherIdElement.textContent = `TX-${Date.now()}`;
                
                // Kosongkan daftar item & hitung total
                voucherItemsListElement.innerHTML = '';
                let totalPrice = 0;

                scannedBottles.forEach(botol => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between text-sm';
                    item.innerHTML = `
                        <span>${botol.name}</span>
                        <span>${formatter.format(botol.price)}</span>
                    `;
                    voucherItemsListElement.appendChild(item);
                    totalPrice += botol.price;
                });
                
                // Tampilkan total
                voucherTotalPriceElement.textContent = formatter.format(totalPrice);
                
                // Tampilkan modal
                modalElement.classList.remove('hidden');
                document.body.classList.add('modal-open');
            }
            
            // Mengganti resetScanner menjadi resetSession
            function resetSession() {
                // Sembunyikan modal
                modalElement.classList.add('hidden');
                document.body.classList.remove('modal-open');
                
                // Reset data sesi
                scannedCount = 0;
                scannedBottles = [];
                
                // Perbarui UI
                counterElement.textContent = `${scannedCount} / ${targetCount}`;
                statusTextElement.textContent = "Siap untuk memindai...";
                updateRecapListUI();
                
                // Fokus kembali ke input
                scanInputElement.value = '';
                scanInputElement.focus();
            }

            // ===================================
            // === EVENT LISTENERS
            // ===================================

            // Listener baru untuk input scan
            scanInputElement.addEventListener('keydown', (e) => {
                // Cek jika tombol 'Enter' ditekan
                if (e.key === 'Enter' || e.keyCode === 13) {
                    e.preventDefault(); // Mencegah perilaku default 'Enter'
                    const barcode = scanInputElement.value.trim();
                    
                    if (barcode) {
                        processScan(barcode); // Proses barcode
                    }
                    
                    scanInputElement.value = ''; // Kosongkan input
                }
            });

            // Tombol Cetak Struk
            printButton.addEventListener('click', () => {
                window.print();
            });

            // Tombol Tutup Struk & Pindai Lagi
            closeButton.addEventListener('click', resetSession); // Panggil resetSession

            // Tombol Buka Rekap/Database
            recapButton.addEventListener('click', showRecapModal);

            // Tombol Tutup Rekap/Database
            closeRecapButton.addEventListener('click', hideRecapModal);

            // Tombol Simpan Data Botol
            addBottleButton.addEventListener('click', handleAddMasterData);

            // ===================================
            // === INISIALISASI APLIKASI
            // ===================================
            loadMasterData(); // Muat database dari localStorage
            scanInputElement.focus(); // Fokus ke input saat memuat halaman
        });
    </script>
</body>
</html>
